\section{Generic Evaluation Proposal}
\label{sec:proposal}
As seen in Section~\ref{sec:EvaluationResults}: Evaluation Results, when evaluating web application firewalls with firewall evasion techniques, an iterative approach to developing payloads seems to be a good solution. If the evaluation is done from the perspective of an firewall administrator, access to logs is possible. Using the approach from Section~\ref{sec:evaluation}: Evaluation, bypassing payloads can be developed quickly if the log message and specific matched part of the payload is known. Once a bypassing payload has been successfully developed and tested against the firewall that is to be evaluated, knowledge about possible loopholes is gained and counter measures can be implemented. As stated in Section~\ref{sec:evalinterpretation}: Interpretation of Evaluation Results, even if there is no immediate possibility to implement rules based on the discovered bypass, the knowledge gained can be valuable. Based on what was described in Section~\ref{sec:evaluation}: Evaluation and the results thereof (Section~\ref{sec:EvaluationResults}: Evaluation Results), the following generic evaluation approach is proposed.

\subsection{Proposed step 1: Gathering evasion techniques}
As a first step, research into specific evasion techniques covering the used technologies by a web application that is to be protected by the evaluated firewall is conducted. If the web application uses a NoSQL database, evasion techniques specific to obscuring SQL-injection payloads are ignored in favor of evasion techniques specific to obscuring NoSQL-injection payloads. As detailed in Section~\ref{sec:varioustech}: Various Payloads, some evasion techniques are not specific to any kind of (injection-) attack and can be considered more broadly.

\subsection{Proposed step 2: Single iteration evaluation}
After evasasion techniques to be evaluated against the tested firewall have been chosen, they are used to create proof-of-concept payloads in a separate fashion. Every evasion technique is evaluated against the firewall configuration by itself. The crafted payloads are subsequently tested against the firewall while analyzing the firewall log to take note on which payloads show potential to be used within a multi iteration approach. Potential can be classified in 3 different classes: unsuable, semi-usable and full potential. Only semi-usable and full potential evasion techniques are used within the following multi iteration approach.

Taking the results from Section~\ref{sec:casealternationevaluation}: Case Alternation as an example: The log file created by the ModSecurity firewall shows that this evasion technique is to be classified as unusable. When sending a request with a proof-of-concept payload, the log reveals that the regex rule used to filter out the payload is configured to ignore case. As such, this techniques has no effect on any payload sent.

Taking the results from Section~\ref{sec:taggedtemplateliteralsevaluation} as another example: While the evasion technique can be used to send a bypassing proof-of-concept payload in the form of \verb|alert`XSS`| towards the web application, by the way Tagged Template Literals are implemented in JavaScript, some payload limitations incur when using this technique. In the example, because of using Tagged Template Literals, the function \verb|alert()| can no longer be called with a variable given as a parameter. Payload limitations incurred by using Tagged Template Literals are further discussed in Section~\ref{sec:payloadlimitations}: Payload Limitations {\color{red}TODO: wenn section payload limitations removed wird, hier auf firewall evasion fundamentals section hinweisen}. Considering incurred payload limitations, using Tagged Template Literals as an evasion technique is classified semi-usable.

Taking the results from Section~\ref{sec:aurebeshevaluation}: Aurebesh as a third example: Using the Aurebesh evasion technique, the proof-of-concept payload \verb|prompt(1,2)| can be sent without any incurring limitations. As such, using Aurebesh as an evasion technique is classified with full potential.

\subsection{Proposed step 3: Multi iteration evaluation}
\label{sec:genericproposalstep3}
Once evasion techniques showing potential have been discovered by using the proof-of-concept payloads crafted in Step 2, multi iteration evaluation can begin. Initially, payloads of interest are researched or crafted. To keep it relevant, these payloads need to have possible malicious influence on the web application that is to be protected by the evaluated firewall. As in the proposed step 1, the technologies used by the web application are considered when deciding on payload variants. Taking a banking web application using JavaScript in the Frontend as an example, Cross-site-scripting payloads are of interest. Once a payload that could negatively influence the web application is found, iteratively applying the noted evasion techniques from proposed step 2 can begin. Multi iteration evaluation is started by sending the plain, not-yet-obscured payload towards the web application and subsequently analyzing the firewall log. As stated in Section~\ref{sec:evaluation}: Evaluation, each iteration begins with analyzing the firewall log of filtered/rejected requests for matched parts of the payload. Once these parts have been identified, an evasion technique classified as usable in proposed step 2 is used to obscure these parts of the payload. During application of an evasion technique to the payload, the payload needs to be kept valid. The validity of the payload is tested at each iteration. Once the payload has been obscured, it is sent towards to web application. Subsequently checking the firewall logs marks the beginning of the next iteration. If at any iteration the payload passes the filter of the firewall, a new bypassing payload has been discovered.

\subsection{Proposed step 4: Implementing new firewall rules}
With the found bypassing payload from proposed step 3 and the knowledge about the evasion techniques used, new rules to extend the firewall configuration can be established. The crafting of new rules at this point is based on the gained knowledge. Knowing the bypassing payload as well as all applied evasion techniques, it is possible to craft a rule that detects at least one of the applied evasion techniques and therefore can cause the firewall to block the obscured payload. 
Taking the evaluation result of Section~\ref{sec:funconstrconbypass}: Function Constructor + String Concatenation as an example: Rules can be implemented that detect the usage of the function constructor as used in Section~\ref{sec:funconstrconbypass}. This blocks the request as payloads using the mentioned syntax of the bypassing payloads will be detected once this rule is implemented. This specific example is further detailed in the rule proposal under Section~\ref{sec:rulespropfunctionconstructor}: Function Constructor (Results).

Once rules for a specific payload have been developed and implemented, these rules are reflected on the used evasion techniques. Some evasion techniques allow for mutiple vectors to create bypassing payloads. The coverage provided by the newly implemented rules is assessed and potentially additionally found vectors for bypassing payloads are noted down to be used in the next evaluation step. 
\subsection{Continuing the Evaluation}
Finally, the new rules are tested against the found bypassing payloads to verify their detection. After verifying the rules, either the evaluation comes to an end or is continued at the initial phase of Section~\ref{sec:genericproposalstep3}: Proposed step 3: Multi iteration evaluation. If additional vectors for bypassing payloads have been found during the previous step, these are handled first. Handling these first allows to focus on one evasion technique at a time. As shown in Section~\ref{sec:rulespropfunctionconstructorreflection}, more vectors to use the \verb|Function()| constructor were discovered. As such, the focus lied on those during the next evaluation iteration. Once the rule proposed under Section~\ref{sec:rulespropfunctionconstructorreflection} in Listing~\ref{lst:constructorsruleproposal3} was implemented, the focus shifted to the additional proposals stated under Section~\ref{sec:unicodenormprop}, Section~\ref{sec:htmlcharrefprop} and Section~\ref{sec:jsescprop}.

\subsection{Assessment} 
During the evaluation of the ModSecurity firewall using CRS4.1 against targeted Cross-site scripting payloads, which was performed according to the proposal stated in this section, multiple insights were gained. It was shown that from initially 18 gathered evasion technique, 13 evasion techniques could be used in some combination to create bypassing payloads. Evaluation results described under Section~\ref{sec:singleiterationeva} and Section~\ref{sec:multiiteration} state some definitively bypassing payloads that the evaluated firewall configuration could not protect against. With this, knowledge about weaknesses in the ruleset has been gained. In addition to that, less and more impactful evasion techniques could be identified. Some evasion techniques were altogether ineffective, while others offered a multitude of bypassing vectors. Based on the gained combined knowledge of bypassing payloads and multiple bypassing vectors, additional firewall rules could be proposed that would increase the protection by the firewall configuration.

For a complete overview regarding a specific Web application, all potentially malicious payloads based on the used Web technologies powering the Web application to be protected need to be investigated in a similar manner. Nevertheless, the results of evaluating only Cross-site scripting payloads allow an estimation of the firewall performance against the focused Cross-site scripting payloads. No matter if a complete evaluation investigating multiple potential weaknesses or an evaluation investigating only one weakness is conducted, using the proposed evaluation technique allows to explore potential loopholes in the rules configuration in any case. This gives insight into filtering performace and subsequently allows to close those loopholes by implementing new rules.
Depending on the specific web application that is to be protected by the web application firewall, adding rules that completely block some evasion techniques that were detected to be effective might be possible. If that is not the case, it could be possible to blacklist payloads that were discovered during the evaluation. At least, some discovered bypassing payloads are known after the evaluation. With this knowledge, the web application can be fortified using a different methodology to adding firewall filtering rules. If nothing is to be done about the findings, still the knowledge gained about bypassing payloads can be used to estimate the risk posed to the web application.

Furthermore, during the evaluation according to the proposal stated in this section, advantages and disadvantages of this technique became apparent. As every step of this proposal is dependend on the subjects performing the evaluation, it is not predefined which evasion techniques will be used to evaluate. In the first step, some Web technologies that the Web application to protect uses could be missed. Building on this, some evasion techniques existent to create bypassing payloads, which would maliciously influence a Web application using a certain Web technology, could also be missed. 
This could lead to some evasion techniques not being used during the evaluation and subsequently to missed potential bypassing vectors to craft malicious payloads. In addition to that, some malicious payloads could might be missed during the evaluation of known evasion techniques. 
Therefore, this evaluation method does not guarantee full coverage. 
Especially during multi-iteration-evaluation, there are many possible evasion technique combinations. If the evaluation is done manually, the subjectively most promising technique combinations can be used. Should this not yield expected results, a fallback on evaluating using any possible combination is possible.
If a firewall configuration does not block some payloads obscured by certain evasion techniques, incurred payload limitations through using those techniques might be enough to render a bypassing payload invalid. In such a case, the validity of bypassing payloads depends on the implementation details of the web server receiving the requests. 
If this implementation eventually invalidates bypassing payloads, a web application firewall ruleset that does not block all payloads but only allows invalid payloads to bypass might be considered effective at the time of evaluation although the invalidity of payload is based only on implementation details of the web application to be protected. 
If those details change, it is possible that the evaluated firewall configuration suddenly no longer "protects" against some evasion techniques.

Performing the evaluation in a grey box testing manner allowed access to the firewall log file. Access to the firewall log enabled to analyze the rules that matched on a payload and apply target-oriented evasion techniques in subsequent iterations. Developing bypassing payloads in this manner enabled to find weaknesses and subsequently implement measures to avoid discovered bypass vectors. Analyzing the matching rules during each iteration also enabled to discard some evasion techniques from consideration in following iterations. This is the case when some evasion techniques are effectively countered through certain rule configurations. 

